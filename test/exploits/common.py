import requests
import bs4

HEADERS = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/118.0"
}

def create_user(target, username, password) -> bool:
    # Set up target user
    user_data = {
        "username": username,
        "password": password,
    }
    registration_response = requests.post(f"{target}/register.php", data=user_data, headers=HEADERS)

    return bytes("UÅ¼ytkownik utworzony", encoding="utf-8") in registration_response.content

def sign_in(target, username, password) -> dict:
    user_data = {
        "username": username,
        "password": password,
    }
    session = requests.session()
    response = session.post(f"{target}/signin.php", data=user_data, headers=HEADERS)
    return {
        "token": session.cookies.get("TOKEN"),
        "session": session, 
        "response": response
    }

def create_product(target, token, title, description, price):
    data = {
        "title": title,
        "description": description,
        "price": price,
    }
    cookies = {
        "TOKEN": token
    }

    response = requests.post(f"{target}/create_product.php", data=data, cookies=cookies, headers=HEADERS)
    
    start = response.content.find(b"$$")
    end = response.content[start+2:].find(b"$$")
    print(response.content)
    sub = response.content[start:start+2+end]
    value = sub[2:]
    return int(value)

def add_image_from_url(target, token, product_id, path):
    data = {
        "url": path,
    }
    cookies = {
        "TOKEN": token
    }
    response = requests.post(f"{target}/add_image_to_product.php?product_id={product_id}", data=data, cookies=cookies, headers=HEADERS)
    dom = bs4.BeautifulSoup(response.content, "html.parser")
    upload_path = dom.find("img").attrs["src"]
    print(upload_path)